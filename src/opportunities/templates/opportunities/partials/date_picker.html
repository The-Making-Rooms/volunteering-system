{% if dates|length > 0 %}
  <p class="text-xl mb-1">Please indicate your availability:</p>

  <!-- Select all -->
  <div class="flex items-center gap-x-3 mb-2">
    <input
      type="checkbox"
      id="select_all_schedules"
      class="checkbox checkbox-primary"
    />
    <label for="select_all_schedules">Select all</label>
  </div>

  <div class="flex flex-col gap-3">
    {% for d in dates %}
      <div class="flex items-center gap-x-3">
        <input
          class="checkbox checkbox-primary schedule-checkbox"
          type="checkbox"
          id="schedule{% for id in d.ids %}_{{ id }}{% endfor %}"
          name="schedule{% for id in d.ids %}_{{ id }}{% endfor %}"
        />
        <label for="schedule{% for id in d.ids %}_{{ id }}{% endfor %}">
          {{ d.date|date:"d-m-Y" }} | {{ d.start_time|date:"H:i" }} - {{ d.end_time|date:"H:i" }}
        </label>
      </div>
    {% endfor %}
  </div>

  <div class="divider"></div>

  <script>
    (function () {
      const selectAll = document.getElementById('select_all_schedules');
      const itemCheckboxes = document.querySelectorAll('.schedule-checkbox');

      // Toggle all from master
      selectAll.addEventListener('change', function () {
        const checked = this.checked;
        itemCheckboxes.forEach(cb => { cb.checked = checked; });
        // Clear indeterminate if user explicitly toggles master
        this.indeterminate = false;
      });

      // Keep master in sync with individual checkbox changes
      const syncMaster = () => {
        const total = itemCheckboxes.length;
        const checkedCount = Array.from(itemCheckboxes).filter(cb => cb.checked).length;
        selectAll.checked = checkedCount === total && total > 0;
        selectAll.indeterminate = checkedCount > 0 && checkedCount < total;
      };

      itemCheckboxes.forEach(cb => cb.addEventListener('change', syncMaster));
      // Initialize (covers back/forward nav and server-side pre-checked states)
      syncMaster();
    })();
  </script>
{% endif %}
